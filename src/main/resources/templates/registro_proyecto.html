<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.w3.org/1999/xhtml">

<head th:replace="design/header :: head">
    <!-- Tu CSS -->
    <link rel="stylesheet" href="path/to/your/styles.css">
    <!-- Flatpickr CSS -->

<style>
.fecha {
  /* Ocultar el campo de fecha */
  display: none;
}

/* Asignarle una apariencia a label */
.etiqueta {
  border: 1px solid silver;
  border-radius: 4px;
  padding: 0 10px;
  height: 10px;

  display: inline-flex;
  align-items: center;
  justify-content: center;
  height: 30px;
}

.etiqueta:hover {
  background-color: rgba(0, 0, 0, 0.05);
}
</style>
</head>

<body class="bg-sistemasIntegrales" onload="hideMessage()">
    <!-- Mostrar el mensaje si está presente -->
    <div th:if="${message}" id="notificationMessage"
        th:classappend="${messageType == 'success'} ? 'alert alert-success' : 'alert alert-danger'"
        style="padding: 10px; margin-bottom: 15px; border-radius: 5px;">
        <span th:text="${message}"></span>
    </div>
  				  <div class="d-flex left-content-end">
				      <a href="/proyectos/lista-proyectos" class="btn btn-outline-info">
				         <i class="fas fa-plus"></i>GO BACK
				      </a>
				  </div>
<div class="container" style="max-width: 800px;">

    <div class="card o-hidden border-0 shadow-lg my-3">
        <div class="card-body p-0">
            <!-- Nested Row within Card Body -->
            <div>
                <div>
                    <div class="p-3">
                        <div class="text-center">
                            <h2 th:if="${project.id==0}">Project Register</h2>
                            <h2 th:if="${project.id!=0}">Project Edit</h2>
                           
                            
                        </div>
                        <form id="miFormulario" class="user" th:action="@{/proyectos/guardar-proyecto}" th:method="post" th:object="${project}" onsubmit="return validateDates()">
                        
                            <input type="hidden" th:if="${project.id!=0}" th:field="*{id}" th:value="${project.id}">
                            <div class="row">
                            	<div class="col">
                            		<div class="row">
                            		<div class="col-8">
                            			<div class="form-group">
                                            <label for="inputpais" class="form-label">Country</label>
								            <SELECT th:field = "*{pais}"  class="form-control form-control-user"  data-show-subtext="true" data-live-search="true">
												<OPTION th:EACH= "paiss : ${paises}" 
														th:VALUE = "${paiss.nombre}" th:TEXT = "${paiss.nombre}" >										 
												</OPTION >		 
											</SELECT>  
										</div>
									</div>
									
									<div class="col-4">
										<div class="form-group">
											 <label for="inputgestion" class="form-label">Year</label>
											<select th:field="*{gestion}" class="form-control form-control-user" id="inputgestion" required>
											    <option value="0" th:if="${project.gestion == 0}"> </option>
											    <option value="2024" th:selected="${project.gestion == '2024'}">2024</option>
											    <option value="2025" th:selected="${project.gestion == '2025'}">2025</option>
											</select>	                                
										</div>		                                
									</div>
									</div>
                                </div>
                                <div class="col">
                                	<div class="form-group">
                                		<label for="inputcliente" class="form-label">Customer</label>
		                                <input th:field="*{cliente}" type="text" class="form-control form-control-user"
		                                       id="inputcliente" placeholder="Customer name" required>

                                	</div>
                                </div>
                            </div>
                            
                            <div class="row">
                            	<div class="col">
                            		<div class="form-group">
                            			<label for="inputsigla" class="form-label">Acronym</label>
		                                <input th:field="*{sigla}" type="text" class="form-control form-control-user"
		                                       id="inputsigla" placeholder="Project Acronym" required>
                            		
		                                <label for="inputnombre" class="form-label">Name</label>
		                                <input th:field="*{nombre}" type="text" class="form-control form-control-user"
		                                       id="inputnombre" placeholder="Name of project" required>
	                                </div>
                                </div>
                                <div class="col">
                                	<div class="form-group">
                                		<label for="inputdescripcion" class="form-label">Description</label>
		                                <textarea th:field="*{descripcion}" class="form-control form-control-user"
		                                       id="inputdescripcion" placeholder="Brief description of the project"  rows="3"  required></textarea>

                                	</div>
                                </div>
                            </div>
                            <div class="row">
                            	<div class="col">
                            		<div class="form-group">
			                              <label for="inputfechaInicial" class="form-label">Start Date</label>
			                              <input th:field="*{fechaInicial}" 
			                              		th:value="${#dates.format(fechaInicial, 'MM/dd/yyyy')}" 
			                              		type="date"  class="form-control form-control-user"
			                                    id="inputfechaInicial" placeholder="MM/DD/YYYY" required onchange="formatDate(this.value)" >                                	
	                               <!-- Elemento para mostrar la fecha formateada -->
								<p id="formattedDate"></p>
	                                </div>                             	
                                </div>
                                <div class="col">
                                	<div class="form-group">
										 <label for="inputfechaFin" class="form-label">End Date</label>
		                                 <input th:field="*{fechaFin}" type="date" class="form-control form-control-user"
		                                           id="inputfechaFin" onchange="formatDate(this.value)" required>

		                            </div>      
                            	</div>
                            </div>
							<hr>
                            <!-- Agregamos % recurrente y los montos calculados automaticos -->
                            <div class="row">
                                <div class="col">
                                	<div class="form-group">
                                		<label for="inputmontoContrato" class="form-label">Contract amount(USD)</label>
		                                <input th:field="*{montoContrato}"
		                                	   
		                                	   type="number" step="0.01" class="form-control form-control-user"
		                                       id="inputmontoContrato" placeholder="0.00"  min="1"  oninput="calculateMontos(); ">
		                                <small id="errorMonto" class="text-danger" style="display: none;">The amount cannot be less than 0</small>

                                	</div>
                                </div>
                              
                            	<div class="col">
                            		<div class="form-group">
		                                <label for="inputporcentajeRecurrente" class="form-label">Recurring Percentage (%)</label>
		                                <input th:field="*{porcentajeRecurrente}" type="number"  step="0.01" class="form-control form-control-user"
		                                           id="inputporcentajeRecurrente" placeholder="0.00"  min="0" required oninput="calculateMontos();">
		                                <small id="errorMonto" class="text-danger" style="display: none;" >The percentage cannot be negative</small>
                     
                                	</div>                             	
                                </div>

                            </div>
                            <div class="row">
                                <div class="col">
                                	<div class="form-group">
										 <label for="inputmontoRecurrente" class="form-label">Recurring Amount</label>
		                                 <input th:field="*{montoRecurrente}" type="text" step="0.01" class="form-control form-control-user"
		                                           id="inputmontoRecurrente" readonly >
		                            </div>                             	
                                </div>
                                <div class="col">
                                	<div class="form-group">
		                                 <label for="inputmontoNoRecurrente" class="form-label">Non-recurring amount</label>
		                                 <input th:field="*{montoNoRecurrente}" type="text" step="0.01"  class="form-control form-control-user"
		                                           id="inputmontoNoRecurrente" readonly  >
                                
		                            </div>
                                </div>
                            </div>
                            <hr>
                            <!-- Agregamos Supervisor y Responsable del Proyecto -->
                            <div class="row">
                             <label class="form-label">Staff Assignment:</label>
                             </div>
								<!-- Checkbox para Asignar Supervisor -->
								<div class="row">
								    <div class="col">
								        <div class="form-group">
								            <input type="checkbox" id="assignSupervisor" onclick="toggleSupervisor()"> Assign Supervisor
								            <br>
								            <select id="supervisor" name="supervisor" class="form-control form-control-user" disabled>
								                <option value="0" disabled selected>Select staff</option>
								                <option th:each="supervisor : ${beneficiarySupervisor}" 
								                        th:value="${supervisor.id}" 
								                        th:selected="${supervisor.id == selectedSupervisor}"  
								                        th:text="${supervisor.nombres +' '+ (supervisor.apellidos != null ? supervisor.apellidos : '') }">
								                </option>
								            </select>
								        </div>
								    </div>
								    
								    <!-- Checkbox para Asignar Responsable -->
								    <div class="col">
								        <div class="form-group">
								            <input type="checkbox" id="assignResponsable" onclick="toggleResponsable()"> Assign Responsible
								            <br>
								            <select id="responsable" name="responsable" class="form-control form-control-user"  disabled>
								                <option value="0" disabled selected>Select staff</option>
								                <option th:each="responsable : ${beneficiaryResponsable}"
								                        th:value="${responsable.id}"
								                        th:selected="${responsable.id == selectedResponsable}"
								                        th:text="${responsable.nombres +' '+ (responsable.apellidos != null ? responsable.apellidos : '') }">
								                </option>
								            </select>
								        </div>
								    </div>
								</div>
                            
 							<!-- Mostrar mensaje de error si existe -->
                            <div th:if="${error}" class="alert alert-danger" role="alert" style="color: red;">
                                <p th:text="${error}"></p>
                            </div>
                             <button class="btn btn-outline-info text-sistemasIntegralesBtn custom-hover-sistemasIntegrales"
                             					onclick="prepareMonto('inputmontoRecurrente'); prepareMonto('inputmontoNoRecurrente'); showOverlay();">
                                SAVE PROJECT
                             </button>

                        </form>

                    </div>
                </div>
            </div>
        </div>
    </div>

</div>
            <!-- Footer -->
            <footer th:replace="design/footerBar :: footerbar"></footer>
            <!-- End of Footer -->
<div th:replace="design/script :: scripts"></div>
    <!-- Flatpickr JS 
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script>
        flatpickr("#inputfechaInicial", {
            dateFormat: "m/d/Y", // Formato MM/DD/YYYY
            locale: "en" // Idioma inglés
        });
    </script>-->
    <!-- Script para formatear la fecha -->
<script>

function formatDate(value) {
    if (value) {
       // const date = new Date(value); // Crea un objeto Date
//        const options = { year: 'numeric', month: '2-digit', day: '2-digit' }; // Opciones para formatear

        // Usa Intl.DateTimeFormat para formatear la fecha
        //const formattedDate = new Intl.DateTimeFormat('en-US', options).format(date);
        //document.getElementById('formattedDate').textContent = formattedDate; // Muestra la fecha formateada
        // Reemplaza el valor en el input original con la fecha formateada
      
        // Crea un objeto Date a partir de la cadena
        const dateParts = value.split('-'); // Separa el valor en año, mes y día
        const date = new Date(dateParts[0], dateParts[1] - 1, dateParts[2]); // Crea un objeto Date (mes - 1)

        const options = { year: 'numeric', month: '2-digit', day: '2-digit' }; // Opciones para formatear

        // Usa Intl.DateTimeFormat para formatear la fecha
        const formattedDate = new Intl.DateTimeFormat('en-US', options).format(date);
        
        // Reemplaza el valor en el input original con la fecha formateada
        document.getElementById('inputfechaInicial').value = value; // Mantiene el formato YYYY-MM-DD
        document.getElementById('inputfechaInicial').setAttribute('data-formatted', formattedDate); // Almacena el formato legible si es necesario
    
    }
}

</script>
<script>

    function validateDates() {
        var startDate = document.getElementById("inputfechaInicial").value;
        var endDate = document.getElementById("inputfechaFin").value;

        if (new Date(startDate) >= new Date(endDate)) {
            alert("La fecha inicial debe ser menor a la fecha de finalización.");
            return false;  // Evita que el formulario se envíe
        }
        return true;  // Permite el envío del formulario
    }
    
    function calculateMontos() {
        const contractAmount = parseFloat(document.getElementById("inputmontoContrato").value) || 0;
        const percentage = parseFloat(document.getElementById("inputporcentajeRecurrente").value) || 0;

        // Calcular montos
        const montoRecurrente = (contractAmount * (percentage / 100));
        const montoNoRecurrente = contractAmount - montoRecurrente;

        const formateador = new Intl.NumberFormat('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        const numeroFormateado = formateador.format(montoNoRecurrente);
        document.getElementById("inputmontoRecurrente").value = formateador.format(montoRecurrente);
        document.getElementById("inputmontoNoRecurrente").value = formateador.format(montoNoRecurrente); 

    }

    //Validando los combos de SUPERVISOR Y RESPONSABLE
    function toggleSupervisor() {
        const supervisorSelect = document.getElementById("supervisor");
        const assignSupervisorCheck = document.getElementById("assignSupervisor");

        // Habilitar o deshabilitar el combo de supervisor según el checkbox
        supervisorSelect.disabled = !assignSupervisorCheck.checked;
    }

    function toggleResponsable() {
        const responsableSelect = document.getElementById("responsable");
        const assignResponsableCheck = document.getElementById("assignResponsable");
        const assignSupervisorCheck = document.getElementById("assignSupervisor");

        // Si se marca el checkbox de responsable, el de supervisor también debe estar marcado
        if (assignResponsableCheck.checked) {
            assignSupervisorCheck.checked = true;
            toggleSupervisor(); // Asegura que el combo de supervisor se habilite
        }
        
        // Habilitar o deshabilitar el combo de responsable según el checkbox
        responsableSelect.disabled = !assignResponsableCheck.checked;
    }
    
 // Llama a esta función para actualizar el valor antes de enviar el formulario
    function prepareMonto(elementId) {
        const element = document.getElementById(elementId);
        element.value = element.value.replace(/,/g, ''); // Elimina comas antes de enviar al servidor
    }
    //Validamos la seleccion de Check ***SOLO SI HAGO CHECK, si no quiero q valide nada
    function validateForm() {
    const assignSupervisorCheck = document.getElementById("assignSupervisor").checked;
    const assignResponsableCheck = document.getElementById("assignResponsable").checked;
    const supervisorSelect = document.getElementById("supervisor").value;
    const responsableSelect = document.getElementById("responsable").value;

		    // Validar que si está marcado "Asignar Responsable", "Asignar Supervisor" también esté marcado
		    if (assignResponsableCheck && !assignSupervisorCheck) {
		        alert("Debes asignar un supervisor si asignas un responsable.");
		        return false;
		    }
		
		    // Validar que si los checkboxes están marcados, los selects no estén vacíos
		    if (assignSupervisorCheck && supervisorSelect === "0") {
		        alert("Por favor, selecciona un supervisor.");
		        return false;
		    }
		    if (assignResponsableCheck && responsableSelect === "0") {
		        alert("Por favor, selecciona un responsable.");
		        return false;
		    }

	    // Si pasa todas las validaciones, enviar el formulario
	    return true;
    }
</script>
    <script>
        // Función para prevenir el envío del formulario con la tecla Enter
        function disableEnterKey(event) {
            if (event.key === "Enter") {
                event.preventDefault(); // Previene la acción predeterminada (enviar el formulario)
            }
        }

        // Añadir el listener al cargar el documento
        document.addEventListener("DOMContentLoaded", function() {
            const form = document.getElementById("miFormulario"); // Cambia "miFormulario" por el ID de tu formulario
            form.addEventListener("keypress", disableEnterKey);
        });
    </script>
    
        

</body>

</html>








